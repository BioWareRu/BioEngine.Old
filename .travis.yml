sudo: required

env:
  global:
    - CACHE_DIR=$HOME/.cache/docker
    - CACHE_FILE_ASPNET_BUILD=$CACHE_DIR/aspnet-build.tar.gz
    - CACHE_FILE_ASPNETCORE=$CACHE_DIR/aspnetcore.tar.gz
    - DOCKER_COMPOSE_VERSION=1.11.2

cache:
  directories:
  - $CACHE_DIR

services:
  - docker

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - if [ -f ${CACHE_FILE_ASPNET_BUILD} ]; then gunzip -c ${CACHE_FILE_ASPNET_BUILD} | docker load; fi
  - if [ -f ${CACHE_FILE_ASPNETCORE} ]; then gunzip -c ${CACHE_FILE_ASPNETCORE} | docker load; fi
  - if [ ! -f ${CACHE_FILE_ASPNET_BUILD} ]; then docker pull microsoft/aspnetcore-build:1.0-1.1; docker save microsoft/aspnetcore-build:1.0-1.1 | gzip > ${CACHE_FILE_ASPNET_BUILD}; fi
  - if [ ! -f ${CACHE_FILE_ASPNETCORE} ]; then docker pull microsoft/aspnetcore:1.1; docker save microsoft/aspnetcore:1.1 | gzip > ${CACHE_FILE_ASPNETCORE}; fi

script:
  - docker-compose -f docker-compose.ci.build.yml run ci-build
  - docker-compose -f docker-compose.yml -f docker-compose.vs.release.yml build

after_success:
  - if [ "$TRAVIS_BRANCH" == "master" ]; then
    docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
    docker tag biowareru/bioengine-resizr:latest biowareru/bioengine-resizr:1.0-$TRAVIS_BUILD_NUMBER;
    docker push biowareru/bioengine-resizr;
    docker tag biowareru/bioengine-site:latest biowareru/bioengine-site:1.0-$TRAVIS_BUILD_NUMBER;
    docker push biowareru/bioengine-site;
    docker tag biowareru/bioengine-api:latest biowareru/bioengine-api:1.0-$TRAVIS_BUILD_NUMBER;
    docker push biowareru/bioengine-api;
    fi
notifications:
  slack:
    secure: JvaCtPb1onqk9XiuBri7RjKM2U0i3e+ViMOz4QONAvecm8XJB9Tru84yi4V0xDUYjBXUkv7TzozfLJdWuhBkvzI98wTVAdukOf61Sz1Ynq8fNI0W3u11PWr1R653/0APIhc8zB3vvQ+DarI/a/bsQQS86Yg68DfbmX6yx+96LCgap+1kdfoJp8qTRkGHYf9Kx67XyFxL005KnRcyr7DgKQhKMwkBSTgNJfdwDod0aAop1UOjEGk0dkOor2QaQbVk9qkH2sbgyawfDB70k5Oima6BCrUcl+1CNsafS+V4O6aif14c8gYVJJwbnAvvcetwTB6Vbx2w5GWTVbh/NpweQ7Z/bsu75nqi2Ycankcu0dmMFmSlHJ0jvSCoS6dtM9xoYxNp8C0b/Y2VQHwwOBoQr+oshamcVdVTja5LYrRQo+YMnRSFO4tRA768ABPZqbxfJ/BqVdfhnvswNqnILAyALWOoNpEvbLKbotzx748mad9604tNfgUEPRrEkv/WwMJVEPijJ7yKfpZ8rVUNqJmd1/7AneGPuG5+GsdABWGQhFlOyd52u+mc1FXToobudfVpZBKKf3M94XTBFBeJ1GDejYdY9/B1Ov3zBttcfTPqHx5RVMyRhU3cbCyFrEblClwF2e0twtZmM4RasKg3eSCHssqwq0ft283jvZvrrpMV4dY=